apply plugin: 'groovy'
apply plugin: 'war'
apply plugin: 'jetty'

import groovy.sql.Sql

repositories {
  mavenCentral()
}

configurations {
    driver
}
dependencies {
  driver group: 'mysql', name: 'mysql-connector-java', version: '5.1.36'

  providedCompile 'javax.servlet:javax.servlet-api:3.1.0'
  runtime 'javax.servlet.jsp.jstl:javax.servlet.jsp.jstl-api:1.2.1'
}

URLClassLoader loader = GroovyObject.class.classLoader
configurations.driver.each {File file ->
  loader.addURL(file.toURL())
}

def dbProps = [user: 'user', password: 'password', allowMultiQueries: 'true'] as Properties
def dbUrl = 'jdbc:mysql://localhost:3306'
def dbDriver = 'com.mysql.jdbc.Driver'

task createDB << {
  Sql.withInstance(dbUrl, dbProps, dbDriver) { sql ->
//    sql.eachRow("SELECT User,Host FROM mysql.user") { row ->
//      println(row)
//    }

    sql.execute '''
CREATE DATABASE alm;
'''

    sql.execute '''
USE alm;
'''

    sql.execute '''
CREATE TABLE alm_users (
  username VARCHAR(20),
  password VARCHAR(20)
);
'''
  }
}

task dropDB << {
  Sql.withInstance(dbUrl, dbProps, dbDriver) { sql ->
    sql.execute '''
DROP DATABASE alm;
'''
  }
}

war {
  webInf { from 'src/main/webap/WEB-INF' }
}

String tomcatDir = '/usr/local/Cellar/tomcat/8.0.26/libexec/'
task setUpTomcatConf(type: Copy) << {
	println "==> Setting up tomcat conf/tomcat-users.xml:"
  
  // Copy src/tomcat-conf/tomcat-users.xml to destination
  from 'src/tomcat-conf/tomcat-users.xml'
  into tomcatDir + 'conf'
  
  println file(tomcatDir + '/conf/tomcat-users.xml').text
}



